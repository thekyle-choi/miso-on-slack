안전 작업 계획 수립 워크플로우
배경

* 발전소에서는 Toolbox Meeting을 통해 작업 전 산업안전보건법, 사내 안전규정, 아차사고 사례 등을 기반으로 안전 작업 계획을 수립하고 작업을 수행합니다.
* 그러나 기존 Toolbox Meeting에서 작업 계획을 수립하는 과정에서 다음과 같은 어려움이 있었습니다.
    * 법령 검색의 어려움: 산업안전보건법, 시행령, 시행규칙, 안전보건기준규칙 등 방대한 법령 중에서 해당 작업에 적용되는 조항을 찾아 검토하는 것이 어렵습니다.
    * 사고 사례 검색의 어려움: 과거 발생한 아차사고 사례나 유사 작업의 사고 사례를 찾아 참고하는 것이 어렵습니다.
    * 일관성 부족: 작업자의 경험과 지식에 의존하여 계획을 수립하다 보니, 작업자마다 계획의 완성도에 차이가 발생하고 일관된 안전 수준을 유지하기 어렵습니다.

MISO 워크플로우

* 개요
    * 본 워크플로우는 '산업안전보건법', '아차사고사례'를 RAG Dataset에서 검색하여 마크다운 형식의 작업 계획서를 반환합니다.
* 워크플로우 링크 : https://edu.miso.gs/app-config/advanced-chat/e066e5ff-ac12-4249-a485-8011428e063f


    * 워크플로우 노드 설명
        * 시작 : 입력 변수를 설정합니다 (query, image)
        * generate_query(LLM) : 사용자의 쿼리를 RAG 검색용으로 정제합니다.
        * (병렬) RAG 검색 : 사용자의 요청과 관련된 지식을 검색합니다.
        * 작업 계획 생성(LLM) : 마크다운 형식의 작업 계획서를 생성합니다.
        * 종료 : result 변수로 '작업 계획 생성(LLM)'의 출력을 반환합니다.
* MISO에서 직접 실행 예시


* API 명세서 : api 명세_안전 작업 계획 수립 워크플로우.txt
* test용 api key: app-2smJZy7kiJPsaRLuqkVdxzcy
* 입력
    * query
        * 역할 : 사용자의 요청 사항
        * 필수 여부 : true
        * 형식 : string
        * 입력 예시 : "보일러 내부 밀폐공간에서 화학약품을 사용한 청소 작업을 해야 합니다."
    * image
        * 역할 : 현장 참고 사진
        * 필수 여부 : false
        * 형식 : file
        * 입력 예시 : 


* 출력
    * result
        * string, 마크다운 형식 준수
        * 출력 예시

# 작업 계획서
## 1. 작업 개요
**작업명:** 보일러 내부 밀폐공간 화학약품 청소 작업  
**작업장소:** 보일러 본체 내부(밀폐공간)  
**작업일시:** [사용자 입력 필요]  
**작업 인원:** [사용자 입력 필요, 예: 4명(작업자 2명, 감시자 1명, 안전관리자 1명 등)]
### 작업 내용
보일러 내부 밀폐공간에 진입하여 화학약품을 사용한 청소 작업을 수행한다. 작업 전, 산소 및 유해가스 농도 측정, 환기 및 안전장치 점검을 실시하며, 전용 보호구를 착용하고, 감시자를 배치하여 작업자의 안전을 확보한다.
---
## 2. 위험요인 분석
### 주요 위험요인
- **질식·유해가스재해:** 산소 결핍, 유해가스(예: 황화수소, 일산화탄소 등) 농도 상승 위험
- **화학물질노출재해:** 화학약품 취급 중 피부·호흡기 노출, 접촉 위험
- **고온화상재해:** 보일러 내부 잔류 고온, 증기·배관 등
- **추락재해:** 밀폐공간 진입·이동 시 추락 위험(사다리, 협소 공간)
- **협소공간 사고:** 출입 곤란, 긴급시 신속 대피 곤란
### 유해요인
- 화학약품(산·알칼리 등), 유해가스(황화수소, 일산화탄소), 산소결핍, 고온(잔류 열)
---
## 3. 안전조치사항
### 작업 전 준비사항
- [ ] 밀폐공간 작업 허가서 발급 및 작업계획서 승인
- [ ] 산소 및 유해가스 농도(산소, 황화수소, 일산화탄소 등) 측정 및 적정공기 확인
- [ ] 작업 전 안전점검 체크리스트 작성 및 위험성평가 실시
- [ ] 감시자 및 작업책임자 지정, 비상연락체계 구축
- [ ] 화학약품별 물질안전보건자료(MSDS) 비치 및 비상세척설비(세안대 등) 준비
- [ ] 작업자 전원 보호구(방독마스크, 안전모, 보호장갑, 보안경, 안전화, 보호복 등) 착용 확인
- [ ] 환기설비(송풍기 등) 준비 및 가동 확인
### 작업 중 안전수칙
- [ ] 감시자 밀폐공간 외부 상주 및 작업자 모니터링
- [ ] 작업 중 산소 및 유해가스 농도 정기적(수시) 측정
- [ ] 화학약품 취급 시 전용 보호구 착용 및 적정 취급방법 준수
- [ ] 작업자 간 상시 연락체계 유지(무전기, 신호줄 등)
- [ ] 작업 중 이상 징후(어지러움, 두통, 장비 이상 등) 발생 시 즉시 중단 및 대피
- [ ] 정기적으로 환기 실시 및 작업장 내부 적정공기 유지 확인
### 작업 후 조치사항
- [ ] 작업장 청소 및 잔류 약품, 폐기물 안전 처리
- [ ] 보호구 세척 및 점검, 안전장치 원상복구
- [ ] 작업종료 후 밀폐공간 출입구 폐쇄 및 출입제한 표시
---
## 4. 필수 안전보호구
- [ ] 안전모
- [ ] 안전화
- [ ] 보안경/안면보호구
- [ ] 보호장갑(화학약품 전용)
- [ ] 방독마스크/송기마스크/공기호흡기(유해가스·산소결핍 우려 시)
- [ ] 보호복(화학약품 전용)
- [ ] 안전벨트 및 추락방지용구(진입 시)
---
## 5. 관련 법규 준수사항
### 안전보건기준규칙 제619조 (밀폐공간 작업 프로그램의 수립ㆍ시행)
- 밀폐공간 작업 전 작업장 위치, 유해위험요인, 작업정보, 보호구, 비상연락체계 등 포함한 작업 프로그램 수립 및 시행, 출입구 게시
### 안전보건기준규칙 제619조의2 (산소 및 유해가스 농도의 측정)
- 밀폐공간 작업 전 산소 및 유해가스 농도 측정, 평가, 적정공기 미확보 시 환기 및 보호구 지급 등 조치
### 안전보건기준규칙 제620조 (환기 등)
- 작업 전·중에 밀폐공간 환기, 적정공기 상태 유지 의무
### 안전보건기준규칙 제638조 (사후조치)
- 점검 결과 이상 발견 시 즉시 환기, 보호구 지급, 설비 보수 등 안전조치
### 안전보건기준규칙 제639조 (사고 시의 대피 등)
- 산소결핍·유해가스 등 우려 시 즉시 작업 중단 및 대피
### 안전보건기준규칙 제279조 (대피 등)
- 급박한 위험 시 작업 중지, 근로자 대피 및 출입통제
---
## 6. 아차사고 사례 및 예방대책
### 유사 사고 사례
- **사례1:** 보일러 내부 밀폐공간 작업 중 질식유해가스재해 발생할 뻔함(작업 허가서 미발급, 안전점검 미실시, 위험성평가 미반영)
- **사례2:** 보일러 내부 화학약품 저장탱크 작업 중 보호구 미착용 및 안전점검 미실시로 화학물질노출 위험 노출
### 재발방지 대책
- 밀폐공간 작업 시 반드시 작업 허가서 발급 및 감시자 배치
- 작업 전 산소 및 유해가스 농도 측정, 환기 실시
- 화학약품 취급 시 전용 보호구 착용, 비상세척설비 준비
- 작업 전 안전점검 체크리스트 작성 및 위험성평가 실시
- 작업 중 안전관리자 상주 및 정기 점검 실시
- 이상 징후 발견 시 작업 즉시 중단 및 대피
- 모든 조치 이행 확인 및 증빙 자료 작성, 전사 공유
---
**※ 본 계획서는 현장 환경 및 작업 특성에 따라 추가 보완이 필요합니다.**



API 사용 예시

python 코드 예시


* 주의: "sample_image.png" 이미지 파일을 실행되는 python 파일과 같은 경로에 위치시켜야 정상적으로 동작합니다.
* 위의 이미지를 "sample_image.png"로 저장하여 테스트해 주세요. 

import os
import mimetypes
import requests
import json

# ✅ API 키 가져오기
MISO_API_KEY = "app-fbOfCveLX4cqddujVAjeX3fW"

# ✅ MISO API 고정 주소
BASE_API_URL = "https://api.holdings.miso.gs/ext/v1"
UPLOAD_ENDPOINT = f"{BASE_API_URL}/files/upload"
WORKFLOW_ENDPOINT = f"{BASE_API_URL}/workflows/run"
USER_ID = "junior_dev_1"

# ✅ 업로드할 이미지 경로
IMAGE_PATH = "sample_image.png"  # 여기에 실제 파일 경로 입력

# ✅ 1단계: 파일 업로드 (MIME 타입 지정 포함)
def upload_file_with_type(image_path):
    mime_type, _ = mimetypes.guess_type(image_path)
    if not mime_type or not mime_type.startswith("image/"):
        raise ValueError(f"❌ 지원되지 않는 파일 형식입니다: {mime_type}")

    with open(image_path, "rb") as file:
        files = {
            "file": (os.path.basename(image_path), file, mime_type)
        }
        data = {
            "user": USER_ID
        }
        headers = {
            "Authorization": f"Bearer {MISO_API_KEY}"
        }

        print("📤 [이미지 업로드 요청 중...]")
        response = requests.post(UPLOAD_ENDPOINT, headers=headers, files=files, data=data)
        handle_response_errors(response)
        upload_result = response.json()

        print("✅ [파일 업로드 성공]")
        print(json.dumps(upload_result, indent=2, ensure_ascii=False))

        return upload_result["id"]

# ✅ 2단계: 워크플로우 실행
def run_workflow(upload_file_id, query_text):
    headers = {
        "Authorization": f"Bearer {MISO_API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "inputs": {
            "query": query_text,
            "image": {
                "transfer_method": "local_file",
                "upload_file_id": upload_file_id,
                "type": "image"
            }
        },
        "mode": "blocking",
        "user": USER_ID
    }

    print("\n📤 [워크플로우 실행 요청 JSON]")
    print(json.dumps(payload, indent=2, ensure_ascii=False))

    response = requests.post(WORKFLOW_ENDPOINT, headers=headers, data=json.dumps(payload))
    handle_response_errors(response)

    result = response.json()

    print("\n📥 [워크플로우 응답 결과]")
    print(json.dumps(result, indent=2, ensure_ascii=False))

    result_text = result.get("data", {}).get("outputs", {}).get("result", "")

    print("\n✅ [최종 출력 결과]")
    print(result_text if result_text else "⚠️ 결과를 찾을 수 없습니다.")

# ✅ 에러 응답 디버깅용 함수
def handle_response_errors(response):
    if not response.ok:
        print(f"\n❌ [요청 실패] 상태코드: {response.status_code}")
        try:
            error_body = response.json()
            print("❗ 오류 내용:")
            print(json.dumps(error_body, indent=2, ensure_ascii=False))
        except ValueError:
            print("❗ 오류 응답이 JSON 형식이 아닙니다.")
            print("응답 본문:")
            print(response.text)
        response.raise_for_status()

# ✅ 실행 시작
if __name__ == "__main__":
    try:
        file_id = upload_file_with_type(IMAGE_PATH)
        run_workflow(
            upload_file_id=file_id,
            query_text="이 이미지에서 어떤 내용을 알 수 있나요?"
        )
    except Exception as e:
        print(f"\n🔥 예외 발생: {str(e)}")



코드 실행 결과

📤 [이미지 업로드 요청 중...]
✅ [파일 업로드 성공]
{
  "id": "f5bae8ea-4d9c-48d5-bbf1-a55ffe47216d",
  "name": "sample_image.png",
  "size": 342316,
  "extension": "png",
  "mime_type": "image/png",
  "created_by": "c913b90d-8512-4c9a-9cd4-5f7da9dfde28",
  "created_at": 1762492540
}

📤 [워크플로우 실행 요청 JSON]
{
  "inputs": {
    "query": "이 이미지에서 어떤 내용을 알 수 있나요?",
    "image": {
      "transfer_method": "local_file",
      "upload_file_id": "f5bae8ea-4d9c-48d5-bbf1-a55ffe47216d",
      "type": "image"
    }
  },
  "mode": "blocking",
  "user": "junior_dev_1"
}

📥 [워크플로우 응답 결과]
{
  "task_id": "07e28632-bde4-4c82-9ad9-88e93e7aced6",
  "workflow_run_id": "c26812f1-7410-4866-b4b9-c0f106e31499",
  "data": {
    "id": "c26812f1-7410-4866-b4b9-c0f106e31499",
    "workflow_id": "c765bcfc-4994-4564-aba0-befb26adc809",
    "status": "succeeded",
    "outputs": {
      "result": "# 작업 계획서\n\n## 1. 작업 개요\n\n**작업명:** 밀폐공간 내 설비 점검 및 유지보수 작업  \n**작업장소:** 밀폐공간(지하 맨홀 또는 설비 피트 내부)  \n**작업일시:** [사용자 입력 필요]  \n**작업 인원:** 2명 이상(사진 기준 2명, 감시자 필요)  \n\n### 작업 내용\n- 밀폐공간(지하 맨홀 또는 피트) 내부에 출입하여 설비(배관, 밸브, 기타 장치 등)를 점검 및 유지보수하는 작업\n- 사다리를 이용해 하강, 안전벨트 및 안전로프 사용\n- 한 명이 내부에서 작업, 다른 한 명이 외부 또는 입구에서 로프를 지원 및 감시\n\n---\n\n## 2. 위험요인 분석\n\n### 주요 위험요인\n- 밀폐공간 질식 위험(산소결핍, 유해가스 누출)\n- 추락 위험(사다리 이용, 높은 곳에서의 이동)\n- 설비, 배관 접촉에 따른 협착 및 협소공간 내 부상 위험\n- 안전장치 미설치, 보호구 미착용 시 사고 위험\n\n### 유해요인\n- 산소결핍, 유해가스(황화수소, 메탄 등) 존재 가능성\n- 협소공간의 고온, 습기, 조명 불량\n\n---\n\n## 3. 안전조치사항\n\n### 작업 전 준비사항\n- [ ] 밀폐공간 출입 전 산소 및 유해가스 농도 측정(가스검지기 사용)\n- [ ] 작업허가서 및 위험성평가서 작성, 작업허가 승인\n- [ ] 구조장비, 통신장비, 구명장비 준비\n- [ ] 사다리, 안전대, 안전로프 등 안전장치 설치 및 점검\n- [ ] 감시자 지정 및 비상연락 체계 구축\n\n### 작업 중 안전수칙\n- [ ] 작업자는 전원 안전모, 안전화, 안전벨트, 보호장갑, 필요시 방독마스크 착용\n- [ ] 작업 중 지속적인 산소 및 유해가스 농도 모니터링\n- [ ] 감시자가 외부에서 작업자 상태 상시 확인 및 비상시 즉각 구조 지원\n- [ ] 작업자는 안전로프에 항상 연결, 사다리 안전하게 이용\n\n### 작업 후 조치사항\n- [ ] 작업장 정리 및 안전장치 원상복구\n- [ ] 밀폐공간 출입문 안전하게 폐쇄, 출입기록 작성\n\n---\n\n## 4. 필수 안전보호구\n\n- [ ] 안전모\n- [ ] 안전화\n- [ ] 보안경/안면보호구(필요시)\n- [ ] 보호장갑\n- [ ] 안전벨트(풀하네스)\n- [ ] 안전로프\n- [ ] 방독마스크/산소호흡기(유해가스 가능성 시)\n- [ ] 휴대용 가스측정기\n\n---\n\n## 5. 관련 법규 준수사항\n\n### 산업안전보건법 제49조 (밀폐공간의 출입 등)\n- 사업주는 작업자가 밀폐공간에 출입하는 경우 산소 및 유해가스 농도를 측정하고, 필요시 보호구 및 구조장비를 지급·착용하게 하여야 하며, 감시자를 배치해야 함.\n\n### 산업안전보건법 제41조 (추락 등의 위험 방지)\n- 사업주는 추락 위험 장소에 안전난간, 안전대 등 추락방지장치를 설치해야 하며, 작업자는 반드시 이를 착용·사용해야 함.\n\n---\n\n## 6. 아차사고 사례 및 예방대책\n\n### 유사 사고 사례\n- 밀폐공간 점검 중 산소결핍으로 인한 질식, 안전로프 미연결로 인한 추락사고, 감시자 미배치로 인한 신속 구조 지연\n\n### 재발방지 대책\n- 밀폐공간 출입 전 반드시 산소 및 유해가스 측정, 감시자 상시 배치\n- 작업자는 안전벨트 및 로프를 반드시 착용 및 연결\n- 비상시 즉시 구조 가능한 장비와 체계 구축\n- 모든 작업자는 밀폐공간 작업 안전교육 이수\n\n---\n\n**설명:**  \n이미지에서 확인되는 작업은 밀폐공간(지하 맨홀 또는 피트) 내부 작업입니다. 작업자들은 안전모, 안전벨트, 안전로프를 착용하고 있으며, 한 명은 내부에 진입, 다른 한 명은 로프를 이용해 지원 또는 감시 역할을 수행하고 있습니다. 밀폐공간 특성상 질식/중독 위험, 추락 위험이 크므로 관련 법규와 안전수칙을 철저히 준수해야 합니다."
    },
    "error": null,
    "elapsed_time": 40.94396728463471,
    "total_tokens": 2965,
    "total_steps": 6,
    "created_at": 1762492540,
    "finished_at": 1762492581
  }
}

✅ [최종 출력 결과]
# 작업 계획서

## 1. 작업 개요

**작업명:** 밀폐공간 내 설비 점검 및 유지보수 작업  
**작업장소:** 밀폐공간(지하 맨홀 또는 설비 피트 내부)  
**작업일시:** [사용자 입력 필요]  
**작업 인원:** 2명 이상(사진 기준 2명, 감시자 필요)  

### 작업 내용
- 밀폐공간(지하 맨홀 또는 피트) 내부에 출입하여 설비(배관, 밸브, 기타 장치 등)를 점검 및 유지보수하는 작업
- 사다리를 이용해 하강, 안전벨트 및 안전로프 사용
- 한 명이 내부에서 작업, 다른 한 명이 외부 또는 입구에서 로프를 지원 및 감시

---

## 2. 위험요인 분석

### 주요 위험요인
- 밀폐공간 질식 위험(산소결핍, 유해가스 누출)
- 추락 위험(사다리 이용, 높은 곳에서의 이동)
- 설비, 배관 접촉에 따른 협착 및 협소공간 내 부상 위험
- 안전장치 미설치, 보호구 미착용 시 사고 위험

### 유해요인
- 산소결핍, 유해가스(황화수소, 메탄 등) 존재 가능성
- 협소공간의 고온, 습기, 조명 불량

---

## 3. 안전조치사항

### 작업 전 준비사항
- [ ] 밀폐공간 출입 전 산소 및 유해가스 농도 측정(가스검지기 사용)
- [ ] 작업허가서 및 위험성평가서 작성, 작업허가 승인
- [ ] 구조장비, 통신장비, 구명장비 준비
- [ ] 사다리, 안전대, 안전로프 등 안전장치 설치 및 점검
- [ ] 감시자 지정 및 비상연락 체계 구축

### 작업 중 안전수칙
- [ ] 작업자는 전원 안전모, 안전화, 안전벨트, 보호장갑, 필요시 방독마스크 착용
- [ ] 작업 중 지속적인 산소 및 유해가스 농도 모니터링
- [ ] 감시자가 외부에서 작업자 상태 상시 확인 및 비상시 즉각 구조 지원
- [ ] 작업자는 안전로프에 항상 연결, 사다리 안전하게 이용

### 작업 후 조치사항
- [ ] 작업장 정리 및 안전장치 원상복구
- [ ] 밀폐공간 출입문 안전하게 폐쇄, 출입기록 작성

---

## 4. 필수 안전보호구

- [ ] 안전모
- [ ] 안전화
- [ ] 보안경/안면보호구(필요시)
- [ ] 보호장갑
- [ ] 안전벨트(풀하네스)
- [ ] 안전로프
- [ ] 방독마스크/산소호흡기(유해가스 가능성 시)
- [ ] 휴대용 가스측정기

---

## 5. 관련 법규 준수사항

### 산업안전보건법 제49조 (밀폐공간의 출입 등)
- 사업주는 작업자가 밀폐공간에 출입하는 경우 산소 및 유해가스 농도를 측정하고, 필요시 보호구 및 구조장비를 지급·착용하게 하여야 하며, 감시자를 배치해야 함.

### 산업안전보건법 제41조 (추락 등의 위험 방지)
- 사업주는 추락 위험 장소에 안전난간, 안전대 등 추락방지장치를 설치해야 하며, 작업자는 반드시 이를 착용·사용해야 함.

---

## 6. 아차사고 사례 및 예방대책

### 유사 사고 사례
- 밀폐공간 점검 중 산소결핍으로 인한 질식, 안전로프 미연결로 인한 추락사고, 감시자 미배치로 인한 신속 구조 지연

### 재발방지 대책
- 밀폐공간 출입 전 반드시 산소 및 유해가스 측정, 감시자 상시 배치
- 작업자는 안전벨트 및 로프를 반드시 착용 및 연결
- 비상시 즉시 구조 가능한 장비와 체계 구축
- 모든 작업자는 밀폐공간 작업 안전교육 이수

---

**설명:**  
이미지에서 확인되는 작업은 밀폐공간(지하 맨홀 또는 피트) 내부 작업입니다. 작업자들은 안전모, 안전벨트, 안전로프를 착용하고 있으며, 한 명은 내부에 진입, 다른 한 명은 로프를 이용해 지원 또는 감시 역할을 수행하고 있습니다. 밀폐공간 특성상 질식/중독 위험, 추락 위험이 크므로 관련 법규와 안전수칙을 철저히 준수해야 합니다.



코드 흐름 설명

## 전체 흐름 요약

### 1️⃣ 이미지 업로드

* 먼저 사용자가 가지고 있는 **이미지 파일을 MISO 서버에 업로드**합니다.
* 업로드가 성공하면, 서버는 이 파일에 대한 고유한 **파일 ID**를 반환합니다.
* 이 ID는 나중에 워크플로우를 실행할 때 이미지 파일을 참조하는 데 사용됩니다.

### 2️⃣ 워크플로우 실행

* 질문(`query`)과 함께 위에서 받은 **파일 ID**를 포함하여 **워크플로우 실행 요청**을 보냅니다.
* 서버는 이미지와 질문을 분석하여 결과(`result`)를 반환합니다.
* 이 결과는 콘솔에 예쁘게 출력됩니다.

---

## 🧩 필요한 준비사항

| 항목              | 설명                                                              |
| --------------- | --------------------------------------------------------------- |
| 이미지 파일 경로       | 업로드할 PNG, JPG 등의 이미지 파일 경로입니다.                                  |
| 질문 내용 (`query`) | 예: `"이 이미지에서 어떤 정보를 알 수 있나요?"`                                  |
| MISO API 키      | MISO 시스템에 접근할 수 있도록 허가받은 토큰입니다. |

---

## ✅ 실행 순서 정리

1. 이미지 파일을 `upload_file_with_type()` 함수로 업로드합니다.
   * 이때 파일의 **MIME 타입**(image/png 등)도 자동으로 감지합니다.
2. 업로드 성공 시, 받은 **파일 ID**를 이용해 `run_workflow()` 함수를 실행합니다.
   * 질문 텍스트와 파일 ID가 함께 MISO 워크플로우로 전달됩니다.
3. 서버로부터 **AI의 응답 결과**를 받아 출력합니다.
4. 에러가 발생한 경우, **HTTP 상태 코드, 에러 메시지, 상세 정보**를 모두 출력하여 문제를 파악할 수 있도록 도와줍니다.

---

## 요약

> 이미지 하나를 업로드하고,
> 그 이미지를 기반으로 질문을 던지고,
> MISO API가 그 질문에 대해 답변을 주는 코드





참고 자료

* RAG 구성 Dataset

